# Код реферала в Google Tag Manager
## Руководство пользователя

В случае реализации продаж товаров или услуг по партнерской (реферальной программы), 
то часто стоит задача правильного учёта объема продаж отдельного партнёра (реферала). 
В этом случае обычно используются так называемые реферальные ссылки -- присвовение каждому партнёру уникального кода, 
который тот использует в ссылке на ваш сайт, например, http://example.com/?ref=ABC.

При переходе на сайт с таким кодом (ABC), сайт должен зафиксировать с каким кодом выполнен этот переход 
и если этот пользователь сделает покупку на сайте, то учесть эту покупку указанному кодом партнеру (рефералу).

Этот плагин реализует справочник (реестр) партнеров и их кодов, учёт переходов по партнерской ссылке и передачу данных о партнёре 
в [Google Tag Manager](https://tagmanager.google.com/). 
Учёт продаж и статистика работы партнеров осуществляется на уровне аналитических сервисов, 
таких как [Google Analytics](https://analytics.google.com/analytics/web/) 
или [Яндекс.Метрика](https://metrika.yandex.ru/).

Для этого необходимо устравить и настроить плагин и аналичтические службы. Ниже приведена подробная инструкция.

## Установка плагина
1. Скачайте [актуальную версию плагина IN-REG-GTM](https://github.com/ivannikitin-com/in-ref-gtm/archive/master.zip).
2. Установите плагин штатными средствами WordPress (Плагины --> Добавить новый --> Загрузить плагин).
3. Активируйте плагин

## Указание рефералов и их кодов
Перейдите в в раздел WordPress "Пользователи". Нажмите "Добавить нового" или "Изменить" для существующего пользователя, 
который должен быть зарегистрирован как реферал. Укажите правильные данные пользователя (E-mail, имя, фамилия). 
Обратите внимание на параметр "Роль", выберите из списка и установите значение "Партнёр".
Обратите внимание на поле "Отображать как", именно это значение будет передаваться в Google Tag Manager. Установите предпочитаемый вид.

![Параметры пользователя](assets/img/user-settings.png?raw=true)

Ниже в профиле пользователя найдите и укажите его код в поле "Код партнера". Этот код должен быть уникальным. 
Плагин не проверяет уникальность кода, но если он будет дублироваться для нескольких пользователей, плагин будет засчитывать продажи
только первому найденному пользователю.

![Указание кода партнера](assets/img/user-refcode.png?raw=true)

Сохраните изменения, нажав кнопку "Сохранить". 

Перейдите к списку всех пользователей "Пользователи --> Все пользователи". 
В правом версхнем углу экрана найтите "Настройка экрана" и раскройте его. Убедитесь, что галочка "Код партнёра" установлена. 
Сохраните изменения.

![Установка показа колонки Код партнера](assets/img/user-screen-settings.png?raw=true)

Перейдите в список партнёров. Сообщите каждому партнёру его код.

![Список партнеров](assets/img/user-screen-role.png?raw=true)

## Настройки партнёрской программы
Откройте настройки плагина "Параметры --> Коды рефералов". Если требуется, измените параметры, описанные ниже.

### Параметр реферала в ссылке
Этот параметр указывается в ссылке, который передается парнтеру, например, для ващего сайта exapmle.com партнерская ссылка 
будет выглядеть как http://example.com/?ref=ABC, где _ref_ -- это данный параметр, а _ABC_ -- код партнера, указанный выше. 
Такое добавление параметра может быть выполнено для любой страницы вашего сайта. При переходе по такой ссылке плагин
проверит код партнера и, если он правильный, удалит его из URL страницы, то есть пользователи не заменят перехода по партнерской ссылке. 
Значение по умолчанию: _ref_.

### Имя куки реферала
Если при переходе по партнерской ссылке параметр указан верно, его значение будет записано в куки на некоторое время. 
То есть, если пользователь, пришедший по реферальной ссылке, сразу не сделал покупку, то все равно он будет правильно отслежен, 
даже если он вернется на сайт спустя некоторое время и сделает покупку. Этот параметр задает имя куки для сохранения кода партнера.
Значение по умолчанию: _refcode_.

### Время жизни куки
Время, на которое сохраняется куки после первого перехода по партнерской ссылке задается этим параметром и указывается в днях.
Значение по умолчанию: _30 дней_.

### Вывод кода реферала в переменную dataLayer
Для того, чтобы можно было произвольно использовать код и имя партнера в системах аналитики, эти данные могут передаваться в dataLayer 
как переменные уровеня данных. 
Значение по умолчанию: _ref_.

В этой переменной создается обхект со значением
* ref.code - Код партнера
* ref.name - Имя партнера

Если вам не нужно выводить данные в dataLayer, снимите эту галочку.

Подробнее см. [Пять секретов уровня данных или dataLayer в Google Tag Manager](http://prometriki.ru/pyt-sekretov-urovny-dannih-ili-datalayer-v-google-tag-manager/)

## Интеграция с плагином DuracellTomi's Google Tag Manager
Очень удобным способом учета партнеров является использование плагина 
[DuracellTomi's Google Tag Manager for WordPress](https://ru.wordpress.org/plugins/duracelltomi-google-tag-manager/)
Данный плагин автоматически формирует dataLayer для обычного режима или расширенного режима электронной торговли 
если у вас используется [платформа WooCommerce](https://ru.wordpress.org/plugins/woocommerce/). 
Мы настоятельно рекомедуем использовать именно этот способ.WooCommerce

Штатно настройте плагин [DuracellTomi's Google Tag Manager for WordPress](https://ru.wordpress.org/plugins/duracelltomi-google-tag-manager/). 
Установите галочку "Перезапись поля affiliation". Это всё, что требуется!

### Режим расширенной электронной торговри
Если у вас используется режим расширенной электронной торговли, перейжите в отчет 
Google Analytics "Электронная торговля --> Маркетинг --> Код партнера". В этом отчете вы увидите все продажи по своим партнерам.

### Режим стандартной электронной торговри
В стандартном режиме Google Analytics отчета по партнерским кодам нет, но все необходимые данные присуствуют. 
Вам необходимо лишь сделать такой отчет самостоятельно. Если вас всё же угораздило использовать WooCommerce + GTM и при этом 
сидеть в стандартном режиме E-Commerce, то лучше всего обратиться в компанию [Иван Никитин и партнеры](https://ivannikitin.com/) 
и заказать настройку GA на вашем сайте. 

Подробное описание настроек Google Tag Manager и Google Analytics в настроящее руководство не входит.

